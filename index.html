<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Flight Search Bot - Recherche de Vols Intelligente</title>
    <meta name="description" content="Bot de recherche de vols avec intelligence artificielle. Trouvez les meilleurs vols en langage naturel.">
    <meta name="keywords" content="vol, avion, voyage, IA, intelligence artificielle, booking, r√©servation">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úàÔ∏è</text></svg>">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .chat-container {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 8px;
        }

        .message.bot .message-bubble {
            background: white;
            color: #334155;
            border-bottom-left-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        .avatar.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .avatar.bot {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-group {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            min-height: 50px;
            max-height: 120px;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .message-input:focus {
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #64748b;
            font-style: italic;
            margin-bottom: 10px;
            padding: 0 20px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #64748b;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        .examples {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .example-chip {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .example-chip:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        .flight-result {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #0ea5e9;
            border-radius: 16px;
            padding: 20px;
            margin-top: 15px;
        }

        .flight-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #0369a1;
            flex-wrap: wrap;
        }

        .flight-route {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #1e293b;
        }

        .flight-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .detail-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e0f2fe;
        }

        .detail-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-top: 4px;
        }

        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #22c55e;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .error-message {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border: 1px solid #fca5a5;
            color: #dc2626;
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
        }

        .success-animation {
            animation: successPulse 0.6s ease-out;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-success { background: #22c55e; }
        .notification-error { background: #ef4444; }
        .notification-warning { background: #f59e0b; }
        .notification-info { background: #3b82f6; }

        .flight-booking-card {
            background: white;
            padding: 16px;
            margin: 12px 0;
            border-radius: 12px;
            border: 2px solid #e0f2fe;
            position: relative;
            transition: all 0.3s ease;
        }

        .flight-booking-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .flight-booking-card button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        #passengerForm input:focus,
        #passengerForm select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .booking-step {
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #64748b;
            margin-top: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            30% {
                transform: scale(1.4);
                opacity: 0.7;
            }
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 16px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .chat-container {
                height: 400px;
            }

            .flight-details {
                grid-template-columns: 1fr 1fr;
            }

            .examples {
                justify-content: center;
            }

            .example-chip {
                font-size: 12px;
                padding: 6px 12px;
            }

            .message-bubble {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è AI Flight Search</h1>
            <p>Recherchez vos vols avec l'intelligence artificielle</p>
            <div class="status-indicator">
                <div class="status-dot"></div>
                Service en ligne
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message bot">
                <div class="avatar bot">ü§ñ</div>
                <div class="message-bubble">
                    <div>Bonjour ! Je suis votre assistant de recherche de vols intelligent. üõ´</div>
                    <div style="margin-top: 10px;">D√©crivez-moi votre voyage en langage naturel et je trouverai les meilleures options pour vous !</div>
                    
                    <div class="examples">
                        <div class="example-chip" onclick="fillExample('Je veux aller √† Bangkok depuis Bruxelles le 15 mars')">
                            Brussels ‚Üí Bangkok
                        </div>
                        <div class="example-chip" onclick="fillExample('Vol d\'affaires Paris-Tokyo aller-retour pour 2 personnes')">
                            Business Paris-Tokyo
                        </div>
                        <div class="example-chip" onclick="fillExample('Direct flight London to Sydney next month')">
                            London ‚Üí Sydney
                        </div>
                        <div class="example-chip" onclick="fillExample('Vol direct Madrid-New York en premi√®re classe')">
                            Premi√®re classe
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="avatar bot">ü§ñ</div>
            <div>
                L'IA analyse votre demande
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-group">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="Exemple: Je veux aller √† Bangkok depuis Bruxelles le 15 mars en business..."
                        rows="1"
                    ></textarea>
                </div>
                <button id="sendButton" class="send-button" onclick="sendMessage()">
                    ‚û§
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration Webhooks - URLs DE PRODUCTION n8n
        const N8N_WEBHOOK_URL = 'https://adequately-coherent-jaybird.ngrok-free.app/webhook/flight-search';
        
        const BOOKING_WEBHOOKS = {
            flightSelect: 'https://adequately-coherent-jaybird.ngrok-free.app/webhook/flight-select',
            passengerData: 'https://adequately-coherent-jaybird.ngrok-free.app/webhook/passenger-data', 
            bookingConfirm: 'https://adequately-coherent-jaybird.ngrok-free.app/webhook/booking-confirm'
        };
        
        // √âtat de l'application
        let isProcessing = false;
        let sessionId = 'web-' + Date.now();

        // √âtat global de la r√©servation
        let bookingState = {
            selectedFlight: null,
            passengers: [],
            contact: {},
            currentStep: 'search',
            sessionId: sessionId
        };

        // √âl√©ments DOM
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Envoyer avec Entr√©e
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Focus automatique
        messageInput.focus();

        // Fonction pour remplir un exemple
        function fillExample(text) {
            messageInput.value = text;
            messageInput.focus();
            messageInput.style.height = 'auto';
            messageInput.style.height = messageInput.scrollHeight + 'px';
        }

        // Ajouter un message au chat
        function addMessage(content, isUser = false, isFlightResult = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? 'user' : 'bot'}`;
            avatar.textContent = isUser ? 'üë§' : 'ü§ñ';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            if (isFlightResult) {
                bubble.innerHTML = content;
                bubble.classList.add('success-animation');
            } else {
                bubble.innerHTML = content.replace(/\n/g, '<br>');
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Afficher/masquer l'indicateur de frappe
        function showTyping(show = true) {
            typingIndicator.style.display = show ? 'flex' : 'none';
            if (show) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // Afficher notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Dictionnaire des compagnies a√©riennes
        const airlineNames = {
            'AF': 'Air France', 'LH': 'Lufthansa', 'BA': 'British Airways', 'IB': 'Iberia',
            'KL': 'KLM', 'AZ': 'ITA Airways', 'SN': 'Brussels Airlines', 'LX': 'Swiss',
            'OS': 'Austrian Airlines', 'SK': 'SAS', 'AY': 'Finnair', 'TP': 'TAP Portugal',
            'EI': 'Aer Lingus', 'FR': 'Ryanair', 'U2': 'easyJet', 'VY': 'Vueling',
            'W6': 'Wizz Air', 'EW': 'Eurowings', 'HV': 'Transavia'
        };

        function getAirlineName(code) {
            return airlineNames[code] || `${code} Airlines`;
        }

        function getClassEmoji(travelClass) {
            switch(travelClass) {
                case 'FIRST': return 'üëë';
                case 'BUSINESS': return 'üíº';
                case 'PREMIUM_ECONOMY': return '‚≠ê';
                default: return 'üé´';
            }
        }

        function formatTravelClass(travelClass) {
            switch(travelClass) {
                case 'FIRST': return 'Premi√®re';
                case 'BUSINESS': return 'Affaires';
                case 'PREMIUM_ECONOMY': return 'Premium Eco';
                default: return '√âconomique';
            }
        }

        // Formater les r√©sultats de vol avec boutons de r√©servation
        function formatFlightResult(result) {
            if (!result.success) {
                const suggestions = result.suggestions ? result.suggestions.map(s => `‚Ä¢ ${s}`).join('<br>') : '';
                return `
                    <div class="error-message">
                        <strong>‚ùå ${result.message || 'Erreur lors de l\'analyse'}</strong>
                        ${suggestions ? '<br><br><strong>Suggestions:</strong><br>' + suggestions : ''}
                    </div>
                `;
            }

            const confidence = result.searchParams?.aiConfidence || result.confidence || 0;
            const confidenceColor = confidence >= 80 ? '#22c55e' : confidence >= 60 ? '#f59e0b' : '#ef4444';
            const params = result.searchParams || result;

            let flightResultsHtml = '';
            
            // Afficher les vols avec boutons de r√©servation
            if (result.bestFlights && result.bestFlights.length > 0) {
                flightResultsHtml = `
                    // Dans l'interface web, section d'affichage des vols, remplacez temporairement par :
                   <div style="font-size: 13px; color: #64748b; margin-bottom: 8px;">
                       üïê TEST: ${JSON.stringify(flight.schedule).substring(0, 100)}... 
              | Prix: ${JSON.stringify(flight.price).substring(0, 50)}...
                </div>
                `;
            }

            return `
                <div class="flight-result">
                    <div class="flight-header">
                        ‚úàÔ∏è Recherche de vol analys√©e par l'IA
                        <div class="confidence-badge" style="background: ${confidenceColor}">
                            üéØ ${confidence}% confiance
                        </div>
                    </div>
                    
                    <div class="flight-route">
                        ${params.originCity || params.originLocationCode} ‚Üí ${params.destinationCity || params.destinationLocationCode}
                    </div>
                    
                    <div class="flight-details">
                        <div class="detail-item">
                            <div class="detail-label">D√©part</div>
                            <div class="detail-value">${params.departureDate || '√Ä d√©finir'}</div>
                        </div>
                        ${params.returnDate ? `
                            <div class="detail-item">
                                <div class="detail-label">Retour</div>
                                <div class="detail-value">${params.returnDate}</div>
                            </div>
                        ` : ''}
                        <div class="detail-item">
                            <div class="detail-label">Classe</div>
                            <div class="detail-value">${getClassEmoji(params.travelClass)} ${formatTravelClass(params.travelClass)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Passagers</div>
                            <div class="detail-value">üë• ${params.adults || 1}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Type</div>
                            <div class="detail-value">${params.tripType === 'round-trip' ? 'üîÑ Aller-retour' : '‚û°Ô∏è Aller simple'}</div>
                        </div>
                        ${params.nonStop !== null ? `
                            <div class="detail-item">
                                <div class="detail-label">Vol</div>
                                <div class="detail-value">${params.nonStop ? 'üéØ Direct' : 'üîÑ Avec escales'}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 4px solid #22c55e;">
                        <strong>ü§ñ Analyse IA:</strong> ${params.naturalRequest || 'Recherche analys√©e avec succ√®s'}
                        ${params.aiModel ? `<br><small>Mod√®le: ${params.aiModel}</small>` : ''}
                    </div>
                    
                    ${flightResultsHtml}
                </div>
            `;
        }

        // Appel API vers n8n
        async function callFlightAPI(message) {
            try {
                console.log('üîó Appel API n8n:', N8N_WEBHOOK_URL);
                
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        sessionId: sessionId,
                        timestamp: new Date().toISOString(),
                        source: 'web'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('‚úÖ R√©ponse n8n:', result);
                
                return result;
                
            } catch (error) {
                console.error('‚ùå Erreur API n8n:', error);
                
                // Mode d√©mo si l'API n8n n'est pas disponible
                if (N8N_WEBHOOK_URL.includes('your-n8n-instance.com')) {
                    return simulateFlightSearch(message);
                }
                
                throw new Error(`Erreur de connexion: ${error.message}`);
            }
        }

        // Simulation pour la d√©mo (quand n8n n'est pas configur√©)
        function simulateFlightSearch(message) {
            const lowerMessage = message.toLowerCase();
            
            // Villes de demo
            const cities = {
                'brussels': { name: 'Brussels', code: 'BRU' },
                'bruxelles': { name: 'Brussels', code: 'BRU' },
                'bangkok': { name: 'Bangkok', code: 'BKK' },
                'paris': { name: 'Paris', code: 'CDG' },
                'london': { name: 'London', code: 'LHR' },
                'londres': { name: 'London', code: 'LHR' },
                'tokyo': { name: 'Tokyo', code: 'NRT' },
                'sydney': { name: 'Sydney', code: 'SYD' },
                'madrid': { name: 'Madrid', code: 'MAD' }
            };
            
            let foundCities = [];
            Object.entries(cities).forEach(([key, value]) => {
                if (lowerMessage.includes(key)) {
                    foundCities.push({...value, position: lowerMessage.indexOf(key)});
                }
            });
            
            foundCities.sort((a, b) => a.position - b.position);
            
            const isRoundTrip = /aller.?retour|round.?trip|return|retour/i.test(message);
            const isBusiness = /business|affaires/i.test(message);
            const isFirst = /first|premi√®re/i.test(message);
            const isDirect = /direct|non.?stop/i.test(message);
            
            if (foundCities.length >= 2) {
                // Simulation avec vols de demo
                const demoFlights = [
                    {
                        rank: 1,
                        airline: { name: getAirlineName('SN'), code: 'SN' },
                        schedule: { departure: '08:30', arrival: '01:15+1', duration: '15h45m' },
                        route: { stops: 0, stopsText: 'Direct', isDirect: true },
                        price: { amount: 750, currency: 'EUR', formatted: '750 EUR' },
                        score: 95,
                        category: 'Excellent'
                    },
                    {
                        rank: 2,
                        airline: { name: getAirlineName('LH'), code: 'LH' },
                        schedule: { departure: '14:20', arrival: '09:45+1', duration: '17h25m' },
                        route: { stops: 1, stopsText: '1 escale', isDirect: false },
                        price: { amount: 680, currency: 'EUR', formatted: '680 EUR' },
                        score: 88,
                        category: 'Tr√®s bon'
                    },
                    {
                        rank: 3,
                        airline: { name: getAirlineName('AF'), code: 'AF' },
                        schedule: { departure: '10:15', arrival: '06:30+1', duration: '18h15m' },
                        route: { stops: 1, stopsText: '1 escale', isDirect: false },
                        price: { amount: 720, currency: 'EUR', formatted: '720 EUR' },
                        score: 82,
                        category: 'Bon'
                    }
                ];
                
                return {
                    success: true,
                    searchParams: {
                        originCity: foundCities[0].name,
                        destinationCity: foundCities[1].name,
                        originLocationCode: foundCities[0].code,
                        destinationLocationCode: foundCities[1].code,
                        departureDate: '2025-03-15',
                        returnDate: isRoundTrip ? '2025-03-25' : null,
                        travelClass: isFirst ? 'FIRST' : isBusiness ? 'BUSINESS' : 'ECONOMY',
                        nonStop: isDirect ? true : null,
                        adults: 1,
                        tripType: isRoundTrip ? 'round-trip' : 'one-way',
                        naturalRequest: `Vol ${foundCities[0].name} vers ${foundCities[1].name}`,
                        aiConfidence: 85,
                        aiModel: 'demo-mode'
                    },
                    bestFlights: demoFlights
                };
            } else {
                return {
                    success: false,
                    message: 'Impossible d\'identifier les villes d\'origine et de destination',
                    suggestions: [
                        'Incluez clairement les villes de d√©part et d\'arriv√©e',
                        'Exemple: "Vol de Brussels √† Bangkok"',
                        'Villes support√©es: Brussels, Bangkok, Paris, London, Tokyo, Sydney, Madrid'
                    ]
                };
            }
        }

                // Fonction de s√©lection de vol avec vraies donn√©es Amadeus
        async function selectFlight(flightIndex, flightData) {
          console.log('üé´ S√©lection du vol:', flightIndex, flightData);
          
          try {
            // Sauvegarder le vol s√©lectionn√©
            bookingState.selectedFlight = {
              index: flightIndex,
              data: flightData,
              timestamp: new Date().toISOString()
            };
            
            // Afficher le message de traitement
            addMessage('üé´ Vol s√©lectionn√© ! V√©rification du prix en temps r√©el...', false);
            showTyping(true);
            
            const requestPayload = {
              flightIndex: flightIndex, // CRUCIAL: pour retrouver dans originalAmadeusOffers
              flightId: flightData.amadeusId || `flight_${flightIndex}_${Date.now()}`,
              selectedFlight: flightData,
              passengers: 1,
              sessionId: bookingState.sessionId,
              timestamp: new Date().toISOString(),
              originalAmadeusData: flightData.originalAmadeusData // Objet Amadeus complet
            };
            
            console.log('üì§ Envoi donn√©es s√©lection:', requestPayload);
            
            // Appeler l'API de s√©lection de vol
            const response = await fetch(BOOKING_WEBHOOKS.flightSelect, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(requestPayload)
            });
            
            showTyping(false);
            
            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
            }

            const rawText = await response.text();
            
            if (!rawText || rawText.trim() === '') {
              throw new Error('R√©ponse vide du serveur n8n');
            }

            let result;
            try {
              result = JSON.parse(rawText);
            } catch (parseError) {
              throw new Error(`R√©ponse n8n invalide - pas du JSON valide: ${parseError.message}`);
            }
            
            console.log('‚úÖ R√©ponse flight select:', result);
            
            if (result && result.success) {
              displayPriceConfirmation(result);
              bookingState.currentStep = 'passengers';
            } else {
              const errorMsg = result?.error || 'Erreur lors de la s√©lection du vol';
              addMessage(`‚ùå ${errorMsg}`, false);
              showNotification('‚ùå Erreur de s√©lection', 'error');
            }
            
          } catch (error) {
            showTyping(false);
            console.error('‚ùå Erreur s√©lection vol:', error);
            addMessage(`‚ùå Erreur de connexion: ${error.message}`, false);
            showNotification('‚ùå Erreur de s√©lection', 'error');
          }
        }

        // Afficher la confirmation de prix et formulaire passagers
        // Afficher la confirmation de prix et formulaire passagers
        function displayPriceConfirmation(priceResult) {
            console.log('üîç Debug prix re√ßu:', priceResult);
            
            const pricing = priceResult.pricing || {};
            const warnings = priceResult.warnings || [];
            
            // Extraire le prix correctement selon la structure re√ßue
            let finalPrice = 'N/A';
            let currency = 'EUR';
            
            if (pricing.total) {
                finalPrice = parseFloat(pricing.total).toFixed(2);
                currency = pricing.currency || 'EUR';
            } else if (pricing.totalPrice) {
                finalPrice = parseFloat(pricing.totalPrice).toFixed(2);
                currency = pricing.currency || 'EUR';
            } else if (pricing.basePrice) {
                finalPrice = parseFloat(pricing.basePrice).toFixed(2);
                currency = pricing.currency || 'EUR';
            }
            
            console.log('üí∞ Prix final calcul√©:', finalPrice, currency);
            
            let warningsHtml = '';
            if (warnings.length > 0) {
                warningsHtml = `
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 12px; border-radius: 8px; margin: 10px 0;">
                        <strong>‚ö†Ô∏è Attention:</strong><br>
                        ${warnings.map(w => `‚Ä¢ ${w}`).join('<br>')}
                    </div>
                `;
            }
            
            // Afficher statut de confirmation
            const isRealTimeConfirmed = priceResult.pricingConfirmed === true;
            const confirmationText = isRealTimeConfirmed ? 'Prix confirm√© en temps r√©el' : 'Prix bas√© sur la recherche';
            
            const confirmationHtml = `
                <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 2px solid #22c55e; border-radius: 16px; padding: 20px; margin-top: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <span style="font-size: 24px;">${isRealTimeConfirmed ? '‚úÖ' : 'üí∞'}</span>
                        <strong style="color: #15803d; font-size: 16px;">${confirmationText}</strong>
                    </div>
                    
                    ${warningsHtml}
                    
                    <div style="background: white; padding: 15px; border-radius: 12px; margin: 15px 0;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #15803d; margin-bottom: 8px;">
                                ${finalPrice} ${currency}
                            </div>
                            <div style="font-size: 14px; color: #64748b;">
                                Prix confirm√© pour ${pricing.breakdown?.adults || 1} passager(s)
                            </div>
                            ${isRealTimeConfirmed ? '' : '<div style="font-size: 12px; color: #f59e0b; margin-top: 4px;">Prix de la recherche initiale</div>'}
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="showPassengerForm()" 
                                style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                            üë• Continuer - Donn√©es passagers
                        </button>
                    </div>
                </div>
            `;
            
            addMessage(confirmationHtml, false, true);
        }

        // Afficher le formulaire passagers
        function showPassengerForm() {
            const passengerFormHtml = `
                <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 16px; padding: 20px; margin-top: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <span style="font-size: 24px;">üë•</span>
                        <strong style="color: #1e293b; font-size: 16px;">Informations des passagers</strong>
                    </div>
                    
                    <form id="passengerForm" style="space-y: 15px;">
                        <!-- Contact principal -->
                        <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                            <h4 style="color: #374151; margin-bottom: 10px;">üìß Contact principal</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="email" id="contactEmail" placeholder="Email *" required 
                                       style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                <input type="tel" id="contactPhone" placeholder="T√©l√©phone *" required
                                       style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>
                        
                        <!-- Passager 1 -->
                        <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                            <h4 style="color: #374151; margin-bottom: 10px;">‚úàÔ∏è Passager 1</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <input type="text" id="firstName1" placeholder="Pr√©nom *" required
                                       style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                <input type="text" id="lastName1" placeholder="Nom *" required
                                       style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <input type="date" id="birthDate1" placeholder="Date de naissance *" required
                                       style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                <select id="gender1" required
                                        style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                    <option value="">Genre *</option>
                                    <option value="MALE">Homme</option>
                                    <option value="FEMALE">Femme</option>
                                </select>
                                <input type="text" id="nationality1" placeholder="Nationalit√© (FR) *" required maxlength="2"
                                       style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="text" id="passportNumber1" placeholder="Num√©ro passeport *" required
                                       style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                <input type="date" id="passportExpiry1" placeholder="Expiration passeport *" required
                                       style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="button" onclick="submitPassengerData()" 
                                    style="background: linear-gradient(135deg, #059669, #047857); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);">
                                ‚úàÔ∏è Confirmer et r√©server
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            addMessage(passengerFormHtml, false, true);
        }

        // Soumettre les donn√©es passagers
        async function submitPassengerData() {
            console.log('üìã Soumission donn√©es passagers...');
            
            try {
                // Collecter les donn√©es du formulaire
                const passengerData = {
                    sessionId: bookingState.sessionId,
                    flightId: bookingState.selectedFlight?.data?.id || 'temp_id',
                    contact: {
                        email: document.getElementById('contactEmail').value,
                        phone: document.getElementById('contactPhone').value
                    },
                    passengers: [{
                        firstName: document.getElementById('firstName1').value,
                        lastName: document.getElementById('lastName1').value,
                        dateOfBirth: document.getElementById('birthDate1').value,
                        gender: document.getElementById('gender1').value,
                        document: {
                            number: document.getElementById('passportNumber1').value,
                            expiryDate: document.getElementById('passportExpiry1').value,
                            nationality: document.getElementById('nationality1').value.toUpperCase()
                        }
                    }],
                    expectedPassengers: 1
                };
                
                // Validation c√¥t√© client
                if (!passengerData.contact.email || !passengerData.contact.phone) {
                    showNotification('‚ùå Informations de contact manquantes', 'error');
                    return;
                }
                
                if (!passengerData.passengers[0].firstName || !passengerData.passengers[0].lastName) {
                    showNotification('‚ùå Nom et pr√©nom requis', 'error');
                    return;
                }
                
                addMessage('üìã Validation des donn√©es passagers...', false);
                showTyping(true);
                
                // Appeler l'API de validation passagers
                const response = await fetch(BOOKING_WEBHOOKS.passengerData, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(passengerData)
                });
                
                showTyping(false);
                
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Sauvegarder les donn√©es valid√©es
                    bookingState.passengers = result.validatedPassengers;
                    bookingState.contact = passengerData.contact;
                    
                    // Afficher la confirmation finale
                    displayBookingConfirmation(result);
                    bookingState.currentStep = 'confirm';
                } else {
                    addMessage(`‚ùå ${result.message || 'Erreur validation donn√©es'}<br>Erreurs: ${result.errors?.join('<br>') || ''}`, false);
                    showNotification('‚ùå Donn√©es invalides', 'error');
                }
                
            } catch (error) {
                showTyping(false);
                console.error('Erreur donn√©es passagers:', error);
                addMessage(`‚ùå Erreur de connexion: ${error.message}`, false);
                showNotification('‚ùå Erreur de validation', 'error');
            }
        }

        // Afficher la confirmation finale
        function displayBookingConfirmation(validationResult) {
            const warnings = validationResult.warnings || [];
            const summary = validationResult.summary || {};
            
            let warningsHtml = '';
            if (warnings.length > 0) {
                warningsHtml = `
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 13px;">
                        <strong>‚ö†Ô∏è V√©rifications:</strong><br>
                        ${warnings.map(w => `‚Ä¢ ${w}`).join('<br>')}
                    </div>
                `;
            }
            
            const confirmationHtml = `
                <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 16px; padding: 20px; margin-top: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <span style="font-size: 24px;">üé´</span>
                        <strong style="color: #92400e; font-size: 16px;">Pr√™t pour la r√©servation</strong>
                    </div>
                    
                    ${warningsHtml}
                    
                    <div style="background: white; padding: 15px; border-radius: 12px; margin: 15px 0;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #92400e; margin-bottom: 8px;">
                                ‚úÖ ${summary.totalPassengers || 1} passager(s) valid√©(s)
                            </div>
                            <div style="font-size: 14px; color: #64748b;">
                                Toutes les donn√©es sont correctes
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 12px; margin: 15px 0;">
                        <div style="font-size: 14px; color: #374151;">
                            <strong>üìã R√©capitulatif:</strong><br>
                            ‚Ä¢ Vol: ${bookingState.selectedFlight?.data?.airline?.name || 'Vol s√©lectionn√©'}<br>
                            ‚Ä¢ Passager: ${bookingState.passengers?.[0]?.name?.firstName || 'N/A'} ${bookingState.passengers?.[0]?.name?.lastName || 'N/A'}<br>
                            ‚Ä¢ Contact: ${bookingState.contact?.email || 'N/A'}<br>
                            ‚Ä¢ Prix estim√©: ${bookingState.selectedFlight?.data?.price?.formatted || 'N/A'}
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="confirmBooking()" 
                                style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);">
                            üî• CONFIRMER LA R√âSERVATION
                        </button>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">
                            En confirmant, vous acceptez les conditions de r√©servation
                        </div>
                    </div>
                </div>
            `;
            
            addMessage(confirmationHtml, false, true);
        }

        // Confirmer la r√©servation finale
        async function confirmBooking() {
            console.log('üî• Confirmation r√©servation finale...');
            
            try {
                const bookingConfirmation = {
                    sessionId: bookingState.sessionId,
                    flightId: bookingState.selectedFlight?.data?.id || 'temp_id',
                    selectedFlight: bookingState.selectedFlight?.data,
                    passengers: bookingState.passengers,
                    contact: bookingState.contact,
                    payment: {
                        method: 'simulation',
                        amount: bookingState.selectedFlight?.data?.price?.amount || 0,
                        currency: bookingState.selectedFlight?.data?.price?.currency || 'EUR'
                    },
                    timestamp: new Date().toISOString()
                };
                
                addMessage('üî• Cr√©ation de la r√©servation en cours...', false);
                showTyping(true);
                
                // Appeler l'API de confirmation finale
                const response = await fetch(BOOKING_WEBHOOKS.bookingConfirm, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bookingConfirmation)
                });
                
                showTyping(false);
                
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Afficher la confirmation de r√©servation
                    displayBookingSuccess(result);
                    bookingState.currentStep = 'completed';
                    showNotification('üéâ R√©servation confirm√©e !', 'success');
                } else {
                    addMessage(`‚ùå ${result.message || 'Erreur lors de la r√©servation'}<br>D√©tails: ${result.details || ''}`, false);
                    showNotification('‚ùå √âchec de la r√©servation', 'error');
                }
                
            } catch (error) {
                showTyping(false);
                console.error('Erreur confirmation r√©servation:', error);
                addMessage(`‚ùå Erreur de connexion: ${error.message}`, false);
                showNotification('‚ùå Erreur de r√©servation', 'error');
            }
        }

        // Afficher le succ√®s de la r√©servation
        function displayBookingSuccess(bookingResult) {
            const booking = bookingResult.booking || {};
            const confirmationNumber = bookingResult.confirmationNumber || 'FB' + Date.now().toString(36).toUpperCase();
            const emailData = bookingResult.emailData || {};
            
            // Utiliser les donn√©es sauvegard√©es si les donn√©es du serveur sont incompl√®tes
            const flightData = bookingState.selectedFlight?.data || {};
            const passengerData = bookingState.passengers?.[0] || {};
            const contactData = bookingState.contact || {};
            
            // Construire les informations de vol avec fallback
            const airlineName = emailData.flightDetails?.[0]?.airline || 
                               flightData.airline?.name || 
                               'Brussels Airlines';
            
            const route = `${emailData.flightDetails?.[0]?.departure?.iataCode || 'BRU'} ‚Üí ${emailData.flightDetails?.[0]?.arrival?.iataCode || 'BKK'}`;
            
            const departureTime = emailData.flightDetails?.[0]?.departure?.at ? 
                                new Date(emailData.flightDetails[0].departure.at).toLocaleString('fr-FR') :
                                '15 mars 2025, 08:30';
            
            const duration = emailData.flightDetails?.[0]?.duration || '15h45m';
            
            const passengerName = emailData.passengerName || 
                                `${passengerData.name?.firstName || passengerData.firstName || 'John'} ${passengerData.name?.lastName || passengerData.lastName || 'Doe'}`;
            
            const totalPrice = bookingResult.totalPrice?.toFixed(2) || 
                             flightData.price?.amount?.toFixed(2) || 
                             '750.00';
            
            const currency = bookingResult.currency || 
                           flightData.price?.currency || 
                           'EUR';
            
            const email = emailData.email || 
                         contactData.email || 
                         'test@example.com';
            
            console.log('üìã Donn√©es de r√©servation:', {
                bookingResult,
                flightData,
                passengerData,
                contactData
            });
            
            const successHtml = `
                <div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 3px solid #22c55e; border-radius: 20px; padding: 25px; margin-top: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üéâ</div>
                    
                    <div style="font-size: 24px; font-weight: bold; color: #15803d; margin-bottom: 10px;">
                        R√©servation Confirm√©e !
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 16px; margin: 20px 0; border: 2px solid #22c55e;">
                        <div style="font-size: 28px; font-weight: bold; color: #15803d; margin-bottom: 8px;">
                            ${confirmationNumber}
                        </div>
                        <div style="font-size: 14px; color: #64748b;">
                            Num√©ro de confirmation
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 12px; margin: 15px 0; text-align: left;">
                        <div style="font-size: 14px; color: #374151;">
                            <strong>üìã D√©tails de votre r√©servation:</strong><br><br>
                            
                            <strong>‚úàÔ∏è Vol:</strong><br>
                            ‚Ä¢ ${airlineName} - ${route}<br>
                            ‚Ä¢ D√©part: ${departureTime}<br>
                            ‚Ä¢ Dur√©e: ${duration}<br><br>
                            
                            <strong>üë§ Passager:</strong><br>
                            ‚Ä¢ ${passengerName}<br><br>
                            
                            <strong>üí∞ Prix total:</strong><br>
                            ‚Ä¢ ${totalPrice} ${currency}<br><br>
                            
                            <strong>üìß Confirmation:</strong><br>
                            ‚Ä¢ Email envoy√© √†: ${email}<br>
                            ‚Ä¢ Date: ${new Date().toLocaleDateString('fr-FR')}
                        </div>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin: 15px 0;">
                        <div style="font-size: 13px; color: #92400e;">
                            <strong>üìß Email de confirmation</strong><br>
                            Un email avec tous les d√©tails et votre e-ticket vous a √©t√© envoy√©.
                            V√©rifiez √©galement vos spams.
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button onclick="resetBooking()" 
                                style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; margin-right: 10px;">
                            üîç Nouvelle recherche
                        </button>
                        <button onclick="downloadTicket('${confirmationNumber}')" 
                                style="background: linear-gradient(135deg, #059669, #047857); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer;">
                            üìÑ T√©l√©charger e-ticket
                        </button>
                    </div>
                </div>
            `;
            
            addMessage(successHtml, false, true);
        }

        // R√©initialiser pour une nouvelle r√©servation
        function resetBooking() {
            bookingState = {
                selectedFlight: null,
                passengers: [],
                contact: {},
                currentStep: 'search',
                sessionId: 'web-' + Date.now()
            };
            
            addMessage('üîç Pr√™t pour une nouvelle recherche de vol !', false);
            showNotification('‚ú® Interface r√©initialis√©e', 'info');
        }

        // Simuler t√©l√©chargement ticket
        function downloadTicket(confirmationNumber) {
            showNotification('üìÑ Fonctionnalit√© √† venir - E-ticket', 'info');
            console.log('T√©l√©chargement e-ticket pour:', confirmationNumber);
        }

        // Fonction principale d'envoi
        async function sendMessage() {
            const message = messageInput.value.trim();
            
            if (!message || isProcessing) return;
            
            // D√©sactiver l'interface
            isProcessing = true;
            sendButton.disabled = true;
            messageInput.disabled = true;
            
            // Ajouter le message utilisateur
            addMessage(message, true);
            
            // Vider l'input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Afficher l'indicateur de frappe
            showTyping(true);
            
            try {
                // Appeler l'API
                const result = await callFlightAPI(message);
                
                // Masquer l'indicateur
                showTyping(false);
                
                // Ajouter la r√©ponse
                addMessage(formatFlightResult(result), false, true);
                
                // Notification de succ√®s
                if (result.success) {
                    const flightCount = result.bestFlights?.length || 0;
                    showNotification(`‚úÖ Analyse termin√©e${flightCount > 0 ? ` - ${flightCount} vols trouv√©s` : ''}`, 'success');
                } else {
                    showNotification('‚ö†Ô∏è Veuillez pr√©ciser votre demande', 'warning');
                }
                
            } catch (error) {
                showTyping(false);
                
                // Message d'erreur selon le type
                if (N8N_WEBHOOK_URL.includes('your-n8n-instance.com')) {
                    addMessage(`
                        <div class="error-message">
                            <strong>‚öôÔ∏è Configuration requise</strong><br><br>
                            Cette version de d√©monstration n√©cessite la configuration de votre webhook n8n.<br><br>
                            <strong>√âtapes:</strong><br>
                            1. Remplacez l'URL webhook dans le code<br>
                            2. Configurez votre workflow n8n<br>
                            3. Testez la connexion<br><br>
                            <em>En attendant, vous pouvez tester avec les exemples ci-dessous.</em>
                        </div>
                    `, false, true);
                } else {
                    addMessage(`
                        <div class="error-message">
                            <strong>‚ùå Erreur de connexion</strong><br><br>
                            ${error.message}<br><br>
                            <strong>V√©rifiez:</strong><br>
                            ‚Ä¢ Votre connexion internet<br>
                            ‚Ä¢ La configuration de votre webhook n8n<br>
                            ‚Ä¢ Les param√®tres CORS
                        </div>
                    `, false, true);
                }
                
                showNotification('‚ùå Erreur de connexion', 'error');
                console.error('Erreur compl√®te:', error);
            } finally {
                // R√©activer l'interface
                isProcessing = false;
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        // Gestion des erreurs globales
        window.addEventListener('error', function(e) {
            console.error('Erreur globale:', e.error);
            showNotification('Une erreur inattendue s\'est produite', 'error');
        });

        // V√©rification du statut de connexion
        function checkConnectionStatus() {
            if (navigator.onLine) {
                document.querySelector('.status-indicator .status-dot').style.background = '#22c55e';
                document.querySelector('.status-indicator').innerHTML = `
                    <div class="status-dot"></div>
                    Service en ligne
                `;
            } else {
                document.querySelector('.status-indicator .status-dot').style.background = '#ef4444';
                document.querySelector('.status-indicator').innerHTML = `
                    <div class="status-dot" style="background: #ef4444;"></div>
                    Mode hors-ligne
                `;
            }
        }

        // √âv√©nements de connexion
        window.addEventListener('online', () => {
            checkConnectionStatus();
            showNotification('‚úÖ Connexion r√©tablie', 'success');
        });

        window.addEventListener('offline', () => {
            checkConnectionStatus();
            showNotification('‚ö†Ô∏è Connexion perdue', 'warning');
        });

        // Message d'accueil apr√®s un d√©lai
        setTimeout(() => {
            if (N8N_WEBHOOK_URL.includes('your-n8n-instance.com')) {
                addMessage(`
                    üí° <strong>Version de d√©monstration</strong><br><br>
                    Pour connecter cette interface √† votre backend n8n :<br><br>
                    1. Configurez votre workflow n8n avec les nodes fournis<br>
                    2. Remplacez l'URL webhook dans le code JavaScript<br>
                    3. Testez avec vos propres recherches de vols<br><br>
                    <em>En attendant, vous pouvez tester les fonctionnalit√©s avec les exemples ci-dessus !</em>
                `, false);
            }
        }, 2000);

        // Raccourcis clavier
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter pour envoyer
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
            
            // Escape pour vider l'input
            if (e.key === 'Escape') {
                messageInput.value = '';
                messageInput.style.height = 'auto';
                messageInput.focus();
            }
        });

        // Analytics basiques (optionnel)
        function trackEvent(eventName, data = {}) {
            console.log('üìä Event:', eventName, data);
            
            // Ici vous pouvez ajouter votre code d'analytics
            // Ex: Google Analytics, Mixpanel, etc.
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, data);
            }
        }

        // Initialisation
        console.log('üöÄ Flight Bot Web initialis√©');
        console.log('Session ID:', sessionId);
        console.log('Webhook URL:', N8N_WEBHOOK_URL);
        
        checkConnectionStatus();
        
        // Track page load
        trackEvent('page_load', {
            timestamp: new Date().toISOString(),
            sessionId: sessionId,
            userAgent: navigator.userAgent
        });

        // Message de bienvenue personnalis√© selon l'heure
        function getTimeBasedGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "Bonjour";
            if (hour < 17) return "Bon apr√®s-midi";
            return "Bonsoir";
        }

        // Mise √† jour du message de bienvenue
        setTimeout(() => {
            const greeting = getTimeBasedGreeting();
            const firstMessage = document.querySelector('.message.bot .message-bubble div');
            if (firstMessage) {
                firstMessage.textContent = `${greeting} ! Je suis votre assistant de recherche de vols intelligent. üõ´`;
            }
        }, 100);

        // Service Worker pour le cache (PWA - optionnel)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                console.log('Service Worker support d√©tect√©');
            });
        }

        // Exposer des fonctions pour le debug (d√©veloppement uniquement)
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            window.flightBot = {
                sendMessage,
                addMessage,
                formatFlightResult,
                callFlightAPI,
                selectFlight,
                resetBooking,
                trackEvent
            };
            console.log('üîß Mode d√©veloppement - fonctions expos√©es dans window.flightBot');
        }
    </script>
</body>
</html>
